# OpenRouter Embedded Chat Implementation Plan

**Date:** 2026-02-01  
**Status:** Planned (not started)  
**Owner:** Tanveer  
**Goal:** Add a reusable chat assistant to all authenticated app pages without building a custom chat UI from scratch.

---

## Overview

This plan adds a shared chat widget (existing UI library) across the app and connects it to OpenRouter for AI responses.  
The assistant must:

1. Work on each page with page-aware context (route, country filter, visible data summary).
2. Access database-backed finance data through safe server-side tools.
3. Persist per-user chat history (threads + messages).
4. Respect existing session auth and app design constraints.

---

## Product Decisions

- **AI provider:** OpenRouter (`OPENROUTER_API_KEY` already part of environment model).
- **Model routing:** Start with one stable model alias in `.env` (`OPENROUTER_MODEL`), keep swappable.
- **Chat interface strategy:** Use an **existing embeddable chat UI library** (no custom-from-scratch UI build).
- **Scope for v1:** Text chat + memory + page context + read-only DB tools.
- **Out of scope (v1):** Voice input, charts generated by AI, autonomous writes to DB.

---

## Target Architecture

### Frontend

- Shared widget include injected in authenticated pages (starting with `views/dashboard.ejs`).
- Small page script collects context:
  - `route` (e.g. `/dashboard`)
  - `country` (UK/IN)
  - lightweight page metadata (card totals, date range if available)
- Widget posts to backend API:
  - `POST /api/ai/chat`
  - `GET /api/ai/conversations`
  - `GET /api/ai/conversations/:id/messages`

### Backend

- New router: `routes/ai.js` (auth-protected).
- New service layer:
  - `lib/ai/openrouter-client.js`
  - `lib/ai/chat-orchestrator.js`
  - `lib/ai/prompts.js`
  - `lib/ai/tools.js`
- Tool execution remains server-side only (never client-direct DB access).

### Data Layer

- New DB modules:
  - `db/ai-conversations.js`
  - `db/ai-messages.js`
- New tables for persistence:
  - `ai_conversations`
  - `ai_messages`

---

## Database Changes

Add migration SQL for:

### `ai_conversations`
- `id` (PK)
- `user_id` (FK -> users.id, cascade delete)
- `title` (nullable, auto-generated from first prompt)
- `page_route` (last route used)
- `created_at`, `updated_at`

### `ai_messages`
- `id` (PK)
- `conversation_id` (FK -> ai_conversations.id, cascade delete)
- `role` (`user` | `assistant` | `tool`)
- `content` (TEXT)
- `tool_name` (nullable)
- `tool_payload` (JSONB nullable)
- `created_at`

Indexes:
- `(user_id, updated_at DESC)` on `ai_conversations`
- `(conversation_id, created_at ASC)` on `ai_messages`

---

## API Contract (v1)

### `POST /api/ai/chat`
Request:
- `conversationId` (optional)
- `message` (required)
- `pageContext` (required object)

Behavior:
1. Validate session user.
2. Load/create conversation.
3. Load recent history (token-capped window).
4. Build prompt with system + page context + history.
5. Execute safe tools when model requests them.
6. Save user + assistant messages.
7. Return assistant response (+ conversation id).

### `GET /api/ai/conversations`
- Returns current user conversation list (latest first).

### `GET /api/ai/conversations/:id/messages`
- Returns full message timeline for that conversation (user-scoped).

---

## Tooling Policy (DB Access)

Model cannot run SQL directly. It may call only allowlisted server tools, for example:

- `get_spend_summary({ country, month })`
- `get_income_summary({ country, month })`
- `get_recent_transactions({ country, limit })`
- `get_category_breakdown({ country, fromDate, toDate })`

Rules:
- Every tool injects `user_id` from session.
- Strict parameter validation (type + max ranges).
- Read-only SQL only in v1.
- Return normalized, minimal JSON.

---

## Prompting Strategy

System prompt sections:
1. Role + tone (personal finance copilot).
2. Hard rules (no fabricated balances, no direct DB writes, ask clarifying questions).
3. Data provenance rule (label computed vs inferred).
4. Tool usage rule (must call tools when user asks for account-specific numbers).
5. Page context hint (route/country/current page module).

---

## Implementation Phases

## Phase 1: Schema + Data Access
- Add migration for `ai_conversations` and `ai_messages`.
- Create `db/ai-conversations.js` and `db/ai-messages.js`.
- Add unit tests for CRUD + user scoping.

## Phase 2: OpenRouter Service
- Add `lib/ai/openrouter-client.js`.
- Add `lib/ai/prompts.js` + `lib/ai/tools.js`.
- Add `lib/ai/chat-orchestrator.js` for tool-call loop + persistence.
- Add unit tests with mocked OpenRouter responses.

## Phase 3: API Routes
- Create `routes/ai.js` with 3 endpoints.
- Mount router in `app.js` under auth middleware.
- Add Supertest integration tests for auth + validation + happy path.

## Phase 4: Shared Chat UI Embed
- Add reusable widget include (`views/partials/chat-widget.ejs`).
- Add client script (`public/js/chat-widget.js`) to:
  - open/close widget
  - send messages
  - load history
  - attach page context
- Integrate into `views/dashboard.ejs` first, then other protected views.

## Phase 5: Hardening + UX
- Add rate limiting on chat endpoint.
- Add retry/error states in widget.
- Add loading/typing state.
- Add message truncation and token/window guardrails.

---

## Security Checklist

- Session-auth required for all `/api/ai/*` routes.
- Conversation ownership check on every read/write.
- No raw SQL from model output.
- Redact secrets from logs.
- Input length caps on `message` and context fields.
- Output sanitization before rendering in chat UI.

---

## Environment Variables

Required additions:
- `OPENROUTER_API_KEY`
- `OPENROUTER_MODEL` (example: `openai/gpt-4o-mini` or preferred model on OpenRouter)
- `OPENROUTER_BASE_URL` (default `https://openrouter.ai/api/v1`)
- `AI_MAX_HISTORY_MESSAGES` (default 20)
- `AI_MAX_INPUT_CHARS` (default 4000)

---

## Testing Plan

### Automated
- Unit: DB modules, prompt builder, tool validation, orchestrator.
- Integration: `/api/ai/chat` + history endpoints with auth and ownership checks.
- Regression: Existing auth/dashboard tests remain green.

### Manual (Required Protocol)
After each completed phase:
1. Run `npm test`.
2. Run `npm run dev`.
3. User manually tests feature.
4. Capture feedback and adjust.
5. Merge to `main` only after user approval.
6. Deploy to Railway.

---

## Deliverables

- New plan-compliant chat module backed by OpenRouter.
- Embedded chat UI available on authenticated pages.
- Per-user conversation history persisted in PostgreSQL.
- Page-aware responses using route and context metadata.
- Read-only DB tool access for trusted finance insights.
